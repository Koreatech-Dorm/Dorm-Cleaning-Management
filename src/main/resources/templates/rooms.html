<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: headFragment}"></head>
<body>
<header th:replace="~{fragments/header :: headerFragment}"></header>

<main class="container-fluid px-4 mt-4">
    <div class="container">
        <div class="page-header mb-4">
            <h2>생활관 상태 확인</h2>
            <p>생활관과 층을 선택하여 호실 상태를 확인하세요.</p>
        </div>

        <!-- 필터 섹션 -->
        <div class="filter-section d-flex gap-3 mb-4">
            <div class="filter-group flex-fill">
                <label for="dormSelect" class="form-label">생활관 선택</label>
                    <select class="form-select form-select-lg" id="dormSelect" required>
                    <option value="" selected disabled>생활관을 선택하세요</option>
                    <option th:each="dorm : ${dorms}" 
                            th:value="${dorm.dormCode}"
                            th:text="${dorm.dormCode} + '동'"></option>
                </select>
            </div>

            <div class="filter-group flex-fill">
                <label for="floorSelect" class="form-label">층 선택</label>
                <select class="form-select form-select-lg" id="floorSelect" required>
                    <option value="">층을 선택하세요</option>
                    <option th:each="floor : ${floors}" 
                            th:value="${floor}" 
                            th:text="${floor} + '층'">
                    </option>
                </select>
            </div>

            <div class="d-flex align-items-end">
                <button class="btn btn-primary" onclick="loadRooms()">조회</button>
            </div>
        </div>

        <div class="position-relative mb-3">
            <!-- 상태 범례 -->
            <div class="legend d-flex gap-3 position-absolute start-50 translate-middle-x">
                <div class="legend-item d-flex align-items-center gap-1">
                    <span class="legend-color occupied"></span> 재실
                </div>
                <div class="legend-item d-flex align-items-center gap-1">
                    <span class="legend-color vacant-dirty"></span> 공실 (청소 필요)
                </div>
                <div class="legend-item d-flex align-items-center gap-1">
                    <span class="legend-color vacant-clean"></span> 공실 (청소 완료)
                </div>
            </div>

            <!-- 일괄 상태 변경 컨트롤 -->
            <div id="bulkSection" class="bulk-section d-flex align-items-center gap-3 position-absolute end-0" style="display: none !important;">
                <button id="bulkSelectBtn" class="btn btn-primary">선택</button>
                <div class="bulk-status-group align-items-center">
                    <select id="bulkStatusSelect" class="form-select form-select-sm">
                        <option value="OCCUPIED">재실</option>
                        <option value="VACANT_DIRTY">공실 (청소 필요)</option>
                        <option value="VACANT_CLEAN">공실 (청소 완료)</option>
                    </select>
                </div>
                <button id="applyBulkBtn" class="btn btn-primary">적용</button>
            </div>
        </div>

        <!-- 호실 그리드 -->
        <div class="floor-div col" id="floorDiv" style="margin-top: 6rem;">
            <div class="empty-state" id="emptyState">
                <p>생활관과 층을 선택하여 호실을 조회하세요.</p>
            </div>
        </div> 

        <!-- 상태 변경 모달 -->
        <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statusModalLabel">호실 상태 변경</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                </div>
                <div class="modal-body">
                    <p id="modalRoomNumber"></p>
                    <select class="form-select" id="modalRoomStatus">
                    <option value="OCCUPIED">재실</option>
                    <option value="VACANT_DIRTY">공실 (청소 필요)</option>
                    <option value="VACANT_CLEAN">공실 (청소 완료)</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="saveStatusBtn">저장</button>
                </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const dormSelect = document.getElementById('dormSelect');
        const floorSelect = document.getElementById('floorSelect');
        const floorDiv = document.getElementById('floorDiv');
        const emptyState = document.getElementById('emptyState');
        const bulkSection = document.getElementById('bulkSection');

        // 층별로 방 상태 표시
        async function loadRoomsByDorm() {
            const dormCode = dormSelect.value;

            if (!dormCode) return;

            if (!emptyState) {
                console.warn('emptyState 요소가 없음');
                return;
            }

            floorDiv.innerHTML = '<p>로딩 중...</p>';
            emptyState.style.display = 'none';

            try {
                const res = await fetch(`/api/rooms/info/byDorm?dormCode=${dormCode}`);
                const rooms = await res.json();

                floorDiv.innerHTML = ``;

                if (!rooms || rooms.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }

                // rooms 배열을 층별로 그룹핑
                const floors = {};

                rooms.forEach(room => {
                    const floor = room.floor;    // 1, 2, 3 같은 층 정보
                    if (!floors[floor]) floors[floor] = [];
                    floors[floor].push(room);
                });

                // 층별로 렌더링
                Object.keys(floors).sort().forEach(floor => {
                    // 1) 층 제목 추가
                    const title = document.createElement('h3');
                    title.textContent = `${floor}층`;
                    floorDiv.appendChild(title)

                    // 2) 해당 층의 방 목록 렌더링
                    const roomGrid = document.createElement('div');
                    roomGrid.classList.add('room-grid', 'row');
                    floors[floor].forEach(room => {
                        const div = document.createElement('div');
                        div.classList.add('room-card', 'col-2', 'mb-3', 'p-2');

                        // 상태별 색상 적용
                        if (room.status === 'OCCUPIED') div.classList.add('occupied');
                        else if (room.status === 'VACANT_DIRTY') div.classList.add('vacant-dirty');
                        else div.classList.add('vacant-clean');

                        // 클릭 이벤트
                        div.onclick = () => {
                            if (!bulkMode)
                                openStatusModal(room.roomNumber, room.status);
                            else 
                                selectRoom(room.roomNumber);
                        };
                        
                        div.dataset.roomNumber = room.roomNumber;

                        div.innerHTML = `
                            <div class="room-number fw-bold">${room.roomNumber}</div>
                        `;
                        roomGrid.appendChild(div);
                    });
                    floorDiv.appendChild(roomGrid)
                });
            } catch (err) {
                console.error(err);
                roomGrid.innerHTML = '<p>호실 정보를 불러오는데 실패했습니다.</p>';
            }
        }

        // 생활관 선택 시 층 드롭다운만 갱신
        dormSelect.addEventListener('change', async () => {
            const dormCode = dormSelect.value;

            // 층 드롭다운 초기화
            floorSelect.innerHTML = '<option value="" selected disabled>층을 선택하세요</option>';

            if (!dormCode) return;
            
            // 생활관 상태 정보 층별 표시
            loadRoomsByDorm();

            // 일괄 선택 기능 표시
            if (bulkSection.style.display === 'none' || bulkSection.style.display === '') {
                bulkSection.style.display = 'flex'; // 나타내기
            } else {
                bulkSection.style.display = 'none'; // 숨기기
            }


            // 층 목록 갱신
            try {
                const res = await fetch(`/api/floors?dormCode=${dormCode}`);
                const floors = await res.json();

                if (!floors || floors.length === 0) return;

                floors.forEach(floor => {
                    const opt = document.createElement('option');
                    opt.value = floor;
                    opt.textContent = `${floor}층`;
                    floorSelect.appendChild(opt);
                });
            } catch (err) {
                console.error('층 정보 로드 실패', err);
            }
        });

        // 조회 버튼 클릭 시 호실 정보 갱신
        async function loadRooms() {
            const dormCode = dormSelect.value;
            const floor = floorSelect.value;

            if (!dormCode || !floor) return;

            if (!emptyState) {
                console.warn('emptyState 요소가 없음');
                return;
            }

            floorDiv.innerHTML = '<p>로딩 중...</p>';
            emptyState.style.display = 'none';

            try {
                const res = await fetch(`/api/rooms/info/byFloor?dormCode=${dormCode}&floor=${floor}`);
                const rooms = await res.json();

                floorDiv.innerHTML = ``;

                if (!rooms || rooms.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }

                const roomGrid = document.createElement('div');
                roomGrid.classList.add('room-grid', 'row');
                rooms.forEach(room => {

                    const div = document.createElement('div');
                    div.classList.add('room-card', 'col-2', 'mb-3', 'p-2');

                    if (room.status === 'OCCUPIED') div.classList.add('occupied');
                    else if (room.status === 'VACANT_DIRTY') div.classList.add('vacant-dirty');
                    else div.classList.add('vacant-clean');

                    div.onclick = () => {
                        if (!bulkMode)
                            openStatusModal(room.roomNumber, room.status);
                        else 
                            selectRoom(room.roomNumber);
                    };

                    div.dataset.roomNumber = room.roomNumber;

                    div.innerHTML = `
                        <div class="room-number fw-bold">${room.roomNumber}</div>
                    `;
                    roomGrid.appendChild(div);
                });
                floorDiv.appendChild(roomGrid);
            } catch (err) {
                console.error(err);
                roomGrid.innerHTML = '<p>호실 정보를 불러오는데 실패했습니다.</p>';
            }
        }

        let selectedRoomNumber = null; // 모달에서 사용할 호실 이름

        function openStatusModal(roomNumber, currentStatus) {
            selectedRoomNumber = roomNumber;

            // 모달에 호실 정보 표시
            document.getElementById('modalRoomNumber').textContent = `호실: ${roomNumber}`;
            document.getElementById('modalRoomStatus').value = currentStatus;

            // 모달 띄우기
            const modal = new bootstrap.Modal(document.getElementById('statusModal'));
            modal.show();
        }

        // 저장 버튼 클릭 이벤트
        document.getElementById('saveStatusBtn').addEventListener('click', () => {
            const newStatus = document.getElementById('modalRoomStatus').value;
            const dormCode = dormSelect.value;
            const floor = floorSelect.value;

            if (!dormCode || !selectedRoomNumber) return;

            fetch(`/api/rooms/${selectedRoomNumber}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ newRoomStatus: newStatus, dormCode: dormCode})
            })
            .then(res => {
                if (res.ok) {
                    const modalEl = document.getElementById('statusModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                    // 갱신
                    if (!floor)
                        loadRoomsByDorm();
                    else 
                        loadRooms();
                } else {
                    alert('상태 변경 실패');
                }
            })
            .catch(err => {
                console.error(err);
                alert('오류 발생');
            });
        });
        
        let bulkMode = false;
        document.getElementById('bulkSelectBtn').addEventListener('click', () =>{
            if (bulkMode == false)
            {
                bulkMode = true;

                const cards = document.querySelectorAll('.room-card');
                cards.forEach(card =>{
                    if (!card.classList.contains('select-mode'))
                        card.classList.add('select-mode');
                });

                const bulkSelectBtn = document.getElementById('bulkSelectBtn');
                bulkSelectBtn.classList.remove('btn-primary');
                bulkSelectBtn.classList.add('btn-secondary');
                bulkSelectBtn.textContent = '해제';
            }
            else
            {
                bulkMode = false;

                const cards = document.querySelectorAll('.room-card');
                cards.forEach(card =>{
                    if (card.classList.contains('select-mode'))
                        card.classList.remove('select-mode');
                    else if (card.classList.contains('selected'))
                        card.classList.remove('selected');
                });

                const bulkSelectBtn = document.getElementById('bulkSelectBtn');
                bulkSelectBtn.classList.remove('btn-secondary');
                bulkSelectBtn.classList.add('btn-primary');
                bulkSelectBtn.textContent = '선택';
            }
        });

        // 선택모드에서 호실 선택
        let selectedRooms = []
        function selectRoom(roomNumber) {
            const room = document.querySelector(`.room-card[data-room-number="${roomNumber}"]`);

            const isSelected = selectedRooms.includes(roomNumber);

            if (!isSelected) {
                room.classList.remove('select-mode');
                room.classList.add('selected');
                selectedRooms.push(roomNumber);
            } else {
                room.classList.remove('selected');
                room.classList.add('select-mode');

                // 배열에서 제거
                selectedRooms = selectedRooms.filter(r => r !== roomNumber);
            }
        }

        // 호실 상태 일괄 변경
        function updateAllSelectedRoom() {
            const newStatus = document.getElementById('bulkStatusSelect').value;
            const dormCode = dormSelect.value;
            const floor = floorSelect.value;

            if (!dormCode || selectedRooms.length < 1) return;
            
            selectedRooms.forEach(roomNumber =>{
                fetch(`/api/rooms/${roomNumber}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newRoomStatus: newStatus, dormCode: dormCode})
                })
                .then(res => {
                    if (res.ok) {
                        // 갱신
                        if (!floor)
                            loadRoomsByDorm();
                        else 
                            loadRooms();
                    } else {
                        alert(`${roomNumber}호 상태 변경 실패`);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('오류 발생');
                });
            });
        }

        // 일괄 변경 적용 버튼 
        document.getElementById('applyBulkBtn').addEventListener('click', () => {
            updateAllSelectedRoom();
            document.getElementById('bulkSelectBtn').click();
            selectedRooms = [];
        });
    </script>
</main>

<footer th:replace="~{fragments/footer :: footerFragment}"></footer>
</body>
</html>
