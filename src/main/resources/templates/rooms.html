<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: headFragment}"></head>
<body>
<header th:replace="~{fragments/header :: headerFragment}"></header>

<main class="container-fluid px-4 mt-4">
    <div class="container">
        <div class="page-header mb-4">
            <h2>생활관 상태 확인</h2>
            <p>생활관과 층을 선택하여 호실 상태를 확인하세요.</p>
        </div>

        <!-- 호실 상태 책갈피 -->
        <div class="status-tabs mb-0">
            <div class="tab-item active" data-status="">전체</div>
            <div class="tab-item" data-status="OCCUPIED">재실</div>
            <div class="tab-item" data-status="VACANT">공실 (청소 필요)</div>
            <div class="tab-item" data-status="READY">공실 (청소 완료)</div>
        </div>

        <!-- 필터 섹션 -->
        <div class="filter-section d-flex gap-3 mt-0 mb-4">
            <div class="filter-group flex-fill">
                <label for="dormSelect" class="form-label">생활관 선택</label>
                    <select class="form-select form-select-lg" id="dormSelect" required>
                    <option value="" selected disabled>생활관을 선택하세요</option>
                    <option value="">전체</option>
                    <option th:each="dorm : ${dorms}" 
                            th:value="${dorm.dormCode}"
                            th:text="${dorm.dormCode} + '동'"></option>
                </select>
            </div>

            <div class="filter-group flex-fill">
                <label for="floorSelect" class="form-label">층 선택</label>
                <select class="form-select form-select-lg" id="floorSelect" required>
                    <option value="">층을 선택하세요</option>
                </select>
            </div>

            <div class="d-flex align-items-end">
                <button class="btn btn-primary" onclick="loadRooms()">조회</button>
            </div>
        </div>

        <div class="position-relative mb-3">
            <!-- 상태 범례 -->
            <div class="legend d-flex gap-3 position-absolute start-50 translate-middle-x">
                <div class="legend-item d-flex align-items-center gap-1">
                    <span class="legend-color occupied"></span> 재실
                </div>
                <div class="legend-item d-flex align-items-center gap-1">
                    <span class="legend-color vacant"></span> 공실 (청소 필요)
                </div>
                <div class="legend-item d-flex align-items-center gap-1">
                    <span class="legend-color ready"></span> 공실 (청소 완료)
                </div>
            </div>

            <!-- 일괄 상태 변경 컨트롤 -->
            <div id="bulkSection" class="bulk-section d-flex align-items-center gap-3 position-absolute end-0" style="display: flex !important;">
                <div class="align-items-center gap-3 position-absolute end-0" style="width: 300px;">
                    <button id="bulkSelectBtn" class="btn btn-primary position-absolute end-0">편집</button>
                </div>
                <div class="align-items-center gap-3 position-absolute end-0" style="display: flex; flex-direction: row; margin-top: 10rem; width: 300px;">
                    <div class="bulk-status-group align-items-center">
                        <select id="bulkStatusSelect" class="form-select form-select-sm" style="display: none;">
                            <option value="OCCUPIED">재실</option>
                            <option value="VACANT">공실 (청소 필요)</option>
                            <option value="READY">공실 (청소 완료)</option>
                        </select>
                    </div>
                    <button id="applyBulkBtn" class="btn btn-primary position-absolute end-0" style="display: none;">적용</button>
                </div>
            </div>
        </div>

        <!-- 호실 그리드 -->
        <div class="floor-div col" id="floorDiv" style="margin-top: 6rem;">
            <div class="empty-state" id="emptyState">
                <p>생활관과 층을 선택하여 호실을 조회하세요.</p>
            </div>
        </div> 

        <!-- 상태 변경 모달 -->
        <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statusModalLabel">호실 상태 변경</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                </div>
                <div class="modal-body">
                    <p id="modalRoomNumber"></p>
                    <select class="form-select" id="modalRoomStatus">
                    <option value="OCCUPIED">재실</option>
                    <option value="VACANT">공실 (청소 필요)</option>
                    <option value="READY">공실 (청소 완료)</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="saveStatusBtn">저장</button>
                </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const dormSelect = document.getElementById('dormSelect');
        const floorSelect = document.getElementById('floorSelect');
        const floorDiv = document.getElementById('floorDiv');
        const emptyState = document.getElementById('emptyState');
        const bulkSection = document.getElementById('bulkSection');

        // 방 번호(숫자 + 알파벳) 파싱 함수
        function parseRoomNumber(roomNumber) {
            // 숫자 + 선택적 알파벳 1글자 (예: 805, 805A)
            const match = roomNumber.match(/^(\d+)([A-Za-z]?)$/);
            if (!match) return { num: Infinity, suffix: "" };

            return {
                num: Number(match[1]),     // 숫자
                suffix: match[2] || ""     // 알파벳 또는 빈 문자열
            };
        }

        // 정렬 함수
        function sortRooms(rooms) {
            return rooms.sort((a, b) => {
                const A = parseRoomNumber(a.roomNumber);
                const B = parseRoomNumber(b.roomNumber);

                // 1️⃣ 숫자 먼저 비교
                if (A.num !== B.num) return A.num - B.num;

                // 2️⃣ 알파벳 비교
                return A.suffix.localeCompare(B.suffix);
            });
        }

        // 생활관 선택 시 층 드롭다운만 갱신
        dormSelect.addEventListener('change', async () => {
            const dormCode = dormSelect.value;

            // 층 드롭다운 초기화
            floorSelect.innerHTML = '<option value="" selected disabled>층을 선택하세요</option>';
            
            // 갱신
            loadRooms(); 
            resetStatusTabs();

            bulkMode = true;
            document.getElementById('bulkSelectBtn').click();


            // 층 목록 갱신
            try {
                const res = await fetch(`/admin/api/floors?dormCode=${dormCode}`);
                const floors = await res.json();

                if (!floors || floors.length === 0) return;

                floors.forEach(floor => {
                    const opt = document.createElement('option');
                    opt.value = floor;
                    opt.textContent = `${floor}층`;
                    floorSelect.appendChild(opt);
                });
            } catch (err) {
                console.error('층 정보 로드 실패', err);
            }
        });

        // 호실 정보 갱신
        async function loadRooms() {
            const dormCode = dormSelect.value;
            const floor = floorSelect.value;

            if (!emptyState) {
                console.warn('emptyState 요소가 없음');
                return;
            }
            
            floorDiv.innerHTML = '<p>로딩 중...</p>';
            emptyState.style.display = 'none';

            try {
                if (dormCode){           
                    if (floor)
                    {
                        bulkMode = true;
                        document.getElementById('bulkSelectBtn').click();

                        const res = await fetch(`/admin/api/rooms/info/byFloor?dormCode=${dormCode}&floor=${floor}`);
                        const rooms = await res.json();

                        floorDiv.innerHTML = ``;

                        if (!rooms || rooms.length === 0) {
                            emptyState.style.display = 'block';
                            return;
                        }

                        floorDiv.style.marginTop = "10rem";
                        
                        const roomGrid = document.createElement('div');
                        roomGrid.classList.add('room-grid', 'row');

                        const sortedRooms = sortRooms(rooms);
                        sortedRooms.forEach(room => {

                            const div = document.createElement('div');
                            div.classList.add('room-card', 'col-2', 'mb-3', 'p-2');

                            if (room.status === 'OCCUPIED') div.classList.add('occupied');
                            else if (room.status === 'VACANT') div.classList.add('vacant');
                            else div.classList.add('ready');

                            div.onclick = () => {
                                if (!bulkMode)
                                    openStatusModal(room.dormCode, room.roomNumber, room.status);
                                else 
                                    selectRoom(room.dormCode, room.roomNumber);
                            };

                            div.dataset.dormCode = dormCode;
                            div.dataset.roomNumber = room.roomNumber;

                            div.innerHTML = `
                                <div class="room-number fw-bold">${room.roomNumber}</div>
                            `;
                            roomGrid.appendChild(div);
                        });
                        floorDiv.appendChild(roomGrid);
                    }
                    else
                    {
                        const res = await fetch(`/admin/api/rooms/info/byDorm?dormCode=${dormCode}`);
                        const rooms = await res.json();

                        floorDiv.innerHTML = ``;

                        if (!rooms || rooms.length === 0) {
                            emptyState.style.display = 'block';
                            return;
                        }

                        floorDiv.style.marginTop = "6rem";
                        // rooms 배열을 층별로 그룹핑
                        const floors = {};

                        rooms.forEach(room => {
                            const floor = room.floor;    // 1, 2, 3 같은 층 정보
                            if (!floors[floor]) floors[floor] = [];
                            floors[floor].push(room);
                        });

                        // 층별로 렌더링
                        Object.keys(floors).sort().forEach(floor => {
                            // 1) 층 제목 추가
                            const title = document.createElement('h3');
                            title.classList.add('section-title');
                            title.textContent = `${floor}층`;
                            floorDiv.appendChild(title)

                            // 2) 해당 층의 방 목록 렌더링
                            const roomGrid = document.createElement('div');
                            roomGrid.classList.add('room-grid', 'row');

                            const sortedRooms = sortRooms(rooms);
                            sortedRooms.forEach(room => {
                                const div = document.createElement('div');
                                div.classList.add('room-card', 'col-2', 'mb-3', 'p-2');

                                // 상태별 색상 적용
                                if (room.status === 'OCCUPIED') div.classList.add('occupied');
                                else if (room.status === 'VACANT') div.classList.add('vacant');
                                else div.classList.add('ready');

                                // 클릭 이벤트
                                div.onclick = () => {
                                    if (!bulkMode)
                                        openStatusModal(room.dormCode, room.roomNumber, room.status);
                                    else 
                                        selectRoom(room.dormCode, room.roomNumber);
                                };
                                
                                div.dataset.dormCode = dormCode;
                                div.dataset.roomNumber = room.roomNumber;

                                div.innerHTML = `
                                    <div class="room-number fw-bold">${room.roomNumber}</div>
                                `;
                                roomGrid.appendChild(div);
                            });
                            floorDiv.appendChild(roomGrid)
                        });
                    }
                }
                else
                {
                    const res = await fetch("/admin/api/dorms");
                    const dorms = await res.json();

                    floorDiv.innerHTML = ``;
                    floorDiv.style.marginTop = "6rem";

                    for (const dorm of dorms) 
                    {
                        const title = document.createElement('h3');
                        title.classList.add('section-title');
                        title.textContent = `${dorm.dormCode}동`;
                        floorDiv.appendChild(title)

                        const roomRes = await fetch(`/admin/api/rooms/info/byDorm?dormCode=${dorm.dormCode}`);
                        const rooms = await roomRes.json();

                        const roomGrid = document.createElement('div');
                        roomGrid.classList.add('room-grid', 'row');
                        if (rooms && rooms.length !== 0) {
                            const sortedRooms = sortRooms(rooms);
                            sortedRooms.forEach(room => {
                                const div = document.createElement('div');
                                div.classList.add('room-card', 'col-2', 'mb-3', 'p-2');

                                if (room.status === 'OCCUPIED') div.classList.add('occupied');
                                else if (room.status === 'VACANT') div.classList.add('vacant');
                                else div.classList.add('ready');

                                div.onclick = () => {
                                    if (!bulkMode)
                                        openStatusModal(room.dormCode, room.roomNumber, room.status);
                                    else 
                                        selectRoom(room.dormCode, room.roomNumber);
                                };

                                div.dataset.dormCode = dorm.dormCode;
                                div.dataset.roomNumber = room.roomNumber;

                                div.innerHTML = `
                                    <div class="room-number fw-bold">${room.roomNumber}</div>
                                `;
                                roomGrid.appendChild(div);
                            });
                        }
                        floorDiv.appendChild(roomGrid);
                    }
                }
            } catch (err) {
                console.error(err);
                emptyState.innerHTML = `<p>생활관과 층을 선택하여 호실을 조회하세요.</p>`;
                emptyState.style.display = 'flex';
            }
        }

        // 초기 화면
        loadRooms();
        resetStatusTabs();

        // 모달에서 사용할 정보
        let selectedDormCode = null; 
        let selectedRoomNumber = null; 

        function openStatusModal(dormCode, roomNumber, currentStatus) {
            selectedDormCode = dormCode;
            selectedRoomNumber = roomNumber;

            // 모달에 호실 정보 표시
            document.getElementById('modalRoomNumber').textContent = `호실: ${roomNumber}`;
            document.getElementById('modalRoomStatus').value = currentStatus;

            // 모달 띄우기
            const modal = new bootstrap.Modal(document.getElementById('statusModal'));
            modal.show();
        }

        // 저장 버튼 클릭 이벤트
        document.getElementById('saveStatusBtn').addEventListener('click', () => {
            const newStatus = document.getElementById('modalRoomStatus').value;
            const floor = floorSelect.value;

            if (!selectedDormCode || !selectedRoomNumber) return;

            fetch(`/admin/api/rooms/${selectedRoomNumber}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ newRoomStatus: newStatus, dormCode: selectedDormCode})
            })
            .then(async (res) => {
                if (res.ok) {
                    const modalEl = document.getElementById('statusModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();

                    // 갱신
                    floorDiv.style.visibility = 'hidden';
                    await loadRooms(); 
                    applyStatusFilter(selectedStatus);
                    floorDiv.style.visibility = 'visible';
                } else {
                    alert('상태 변경 실패');
                }
            })
            .catch(err => {
                console.error(err);
                alert('오류 발생');
            });
        });
        
        let bulkMode = false;
        document.getElementById('bulkSelectBtn').addEventListener('click', () =>{
            if (bulkMode == false)
            {
                bulkMode = true;

                const cards = document.querySelectorAll('.room-card');
                cards.forEach(card =>{
                    if (!card.classList.contains('select-mode'))
                        card.classList.add('select-mode');
                });

                const bulkSelectBtn = document.getElementById('bulkSelectBtn');
                bulkSelectBtn.classList.remove('btn-primary');
                bulkSelectBtn.classList.add('btn-secondary');
                bulkSelectBtn.textContent = '해제';
                
                const bulkStatusSelect = document.getElementById('bulkStatusSelect');
                const applyBulkBtn = document.getElementById('applyBulkBtn');
                bulkStatusSelect.style.display = 'flex';
                applyBulkBtn.style.display = 'flex';
            }
            else
            {
                bulkMode = false;

                const cards = document.querySelectorAll('.room-card');
                cards.forEach(card =>{
                    if (card.classList.contains('select-mode'))
                        card.classList.remove('select-mode');
                    else if (card.classList.contains('selected'))
                        card.classList.remove('selected');
                });

                const bulkSelectBtn = document.getElementById('bulkSelectBtn');
                bulkSelectBtn.classList.remove('btn-secondary');
                bulkSelectBtn.classList.add('btn-primary');
                bulkSelectBtn.textContent = '편집';

                const bulkStatusSelect = document.getElementById('bulkStatusSelect');
                const applyBulkBtn = document.getElementById('applyBulkBtn');
                bulkStatusSelect.style.display = 'none';
                applyBulkBtn.style.display = 'none';

                selectedRooms = [];
            }
        });

        // 선택모드에서 호실 선택
        let selectedRooms = []
        function selectRoom(dormCode, roomNumber) {
            const room = document.querySelector(`.room-card[data-dorm-code="${dormCode}"][data-room-number="${roomNumber}"]`);
            
            // 이미 선택됐는지 확인
            const isSelected = selectedRooms.some(
                r => r[0] === dormCode && r[1] === roomNumber
            );

            if (!isSelected) {
                room.classList.remove('select-mode');
                room.classList.add('selected');
                selectedRooms.push([dormCode, roomNumber]);
            } else {
                room.classList.remove('selected');
                room.classList.add('select-mode');

                // 배열에서 제거
                selectedRooms = selectedRooms.filter(
                    r => !(r[0] === dormCode && r[1] === roomNumber)
                );
            }
        }

        // 호실 상태 일괄 변경
        async function updateAllSelectedRoom() {
            const newStatus = document.getElementById('bulkStatusSelect').value;
            const floor = floorSelect.value;

            if (!selectedRooms || selectedRooms.length < 1) return;

            for (const roomInfo of selectedRooms) {
                const [dormCode, roomNumber] = roomInfo;

                try {
                    const res = await fetch(`/admin/api/rooms/${roomNumber}/status`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ newRoomStatus: newStatus, dormCode: dormCode })
                    });

                    if (!res.ok) {
                        alert(`${roomNumber}호 상태 변경 실패`);
                    }

                } catch (err) {
                    console.error(err);
                    alert(`오류 발생 (${roomNumber})`);
                }
            }
            //갱신
            floorDiv.style.visibility = 'hidden';
            await loadRooms();
            applyStatusFilter(selectedStatus);
            floorDiv.style.visibility = 'visible';
        }

        // 일괄 변경 적용 버튼 
        document.getElementById('applyBulkBtn').addEventListener('click', () => {
            updateAllSelectedRoom();
            document.getElementById('bulkSelectBtn').click();
            selectedRooms = [];
        });

        // 책갈피 상태 필터
        const statusTabs = document.querySelectorAll('.status-tabs .tab-item');

        statusTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                statusTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                selectedStatus = tab.dataset.status; 

                applyStatusFilter(selectedStatus);
            });
        });

        // 상태 필터 적용 함수
        let selectedStatus = "";
        function applyStatusFilter(status) {
            const cards = Array.from(document.querySelectorAll('.room-card'));

            // cards 배열을 dataset.roomNumber 기준으로 정렬
            cards.sort((a, b) => {
                const A = parseRoomNumber(a.dataset.roomNumber);
                const B = parseRoomNumber(b.dataset.roomNumber);

                // 1) 숫자 비교
                if (A.num !== B.num) return A.num - B.num;

                // 2) 알파벳 비교
                return A.suffix.localeCompare(B.suffix);
            });

            cards.forEach(card => {
                const cardStatus = 
                    card.classList.contains('occupied') ? "OCCUPIED" :
                    card.classList.contains('vacant') ? "VACANT" :
                    "READY";

                if (status === "" || status === cardStatus) {
                    card.style.display = "flex";
                } else {
                    card.style.display = "none";
                }
            });
        }

        // 상태 기준으로 검색 탭 초기화
        
        function resetStatusTabs() {
            const tabs = document.querySelectorAll('.status-tabs .tab-item');

            tabs.forEach(tab => tab.classList.remove('active'));

            const allTab = document.querySelector('.status-tabs .tab-item[data-status=""]');
            if (allTab) {
                allTab.classList.add('active');
            }
        }


    </script>
</main>

<footer th:replace="~{fragments/footer :: footerFragment}"></footer>
</body>
</html>
