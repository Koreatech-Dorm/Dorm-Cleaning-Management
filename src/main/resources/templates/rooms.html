<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: headFragment}"></head>
<body>
<header th:replace="~{fragments/header :: headerFragment}"></header>

<main>
    <div class="container">
        <div class="page-header mb-4">
            <h2>생활관 상태 확인</h2>
            <p>생활관과 층을 선택하여 호실 상태를 확인하세요.</p>
        </div>

        <!-- 필터 섹션 -->
        <div class="filter-section d-flex gap-3 mb-4">
            <div class="filter-group flex-fill">
                <label for="dormSelect" class="form-label">생활관 선택</label>
                    <select class="form-select form-select-lg" id="dormSelect" required>
                    <option value="" selected disabled>생활관을 선택하세요</option>
                    <option th:each="dorm : ${dorms}" 
                            th:value="${dorm.id}" 
                            th:text="${dorm.dormCode} + '동'"></option>
                </select>
            </div>

            <div class="filter-group flex-fill">
                <label for="floorSelect" class="form-label">층 선택</label>
                <select class="form-select form-select-lg" id="floorSelect" required>
                    <option value="">층을 선택하세요</option>
                    <option th:each="floor : ${floors}" 
                            th:value="${floor}" 
                            th:text="${floor} + '층'">
                    </option>
                </select>
            </div>

            <div class="d-flex align-items-end">
                <button class="btn btn-primary" onclick="loadRooms()">조회</button>
            </div>
        </div>

        <!-- 범례 -->
        <div class="legend d-flex gap-3 mb-3">
            <div class="legend-item d-flex align-items-center gap-1">
                <span class="legend-color occupied"></span> 재실
            </div>
            <div class="legend-item d-flex align-items-center gap-1">
                <span class="legend-color vacant-dirty"></span> 공실 (청소 필요)
            </div>
            <div class="legend-item d-flex align-items-center gap-1">
                <span class="legend-color vacant-clean"></span> 공실 (청소 완료)
            </div>
        </div>

        <!-- 호실 그리드 -->
        <div class="room-grid row" id="roomGrid">
            <div class="empty-state" id="emptyState">
                <p>생활관과 층을 선택하여 호실을 조회하세요.</p>
            </div>
        </div>

        <!-- 상태 변경 모달 -->
        <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statusModalLabel">호실 상태 변경</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                </div>
                <div class="modal-body">
                    <p id="modalRoomNumber"></p>
                    <select class="form-select" id="modalRoomStatus">
                    <option value="OCCUPIED">재실</option>
                    <option value="VACANT_DIRTY">공실 (청소 필요)</option>
                    <option value="VACANT_CLEAN">공실 (청소 완료)</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="saveStatusBtn">저장</button>
                </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const dormSelect = document.getElementById('dormSelect');
        const floorSelect = document.getElementById('floorSelect');
        const roomGrid = document.getElementById('roomGrid');
        const emptyState = document.getElementById('emptyState');

        // 생활관 선택 시 층 드롭다운만 갱신
        dormSelect.addEventListener('change', async () => {
            const dormId = dormSelect.value;

            // 층 드롭다운 초기화
            floorSelect.innerHTML = '<option value="" selected disabled>층을 선택하세요</option>';

            if (!dormId) return;

            try {
                const res = await fetch(`/api/floors?dormId=${dormId}`);
                const floors = await res.json();

                if (!floors || floors.length === 0) return;

                floors.forEach(floor => {
                    const opt = document.createElement('option');
                    opt.value = floor;
                    opt.textContent = `${floor}층`;
                    floorSelect.appendChild(opt);
                });
            } catch (err) {
                console.error('층 정보 로드 실패', err);
            }
        });

        // 조회 버튼 클릭 시 호실 정보 갱신
        async function loadRooms() {
            const dormId = dormSelect.value;
            const floor = floorSelect.value;

            if (!dormId || !floor) return;

            if (!emptyState) {
                console.warn('emptyState 요소가 없음');
                return;
            }

            roomGrid.innerHTML = '<p>로딩 중...</p>';
            emptyState.style.display = 'none';

            try {
                const res = await fetch(`/api/rooms?dormId=${dormId}&floor=${floor}`);
                const rooms = await res.json();

                roomGrid.innerHTML = '';

                if (!rooms || rooms.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }

                rooms.forEach(room => {
                    const div = document.createElement('div');
                    div.classList.add('room-card', 'col-2', 'mb-3', 'p-2');

                    if (room.status === 'OCCUPIED') div.classList.add('occupied');
                    else if (room.status === 'VACANT_DIRTY') div.classList.add('vacant-dirty');
                    else div.classList.add('vacant-clean');

                    div.onclick = () => openStatusModal(room.id, room.number, room.status);

                    div.innerHTML = `
                        <div class="room-number fw-bold">${room.number}</div>
                        <div class="room-status">${room.statusLabel}</div>
                    `;
                    roomGrid.appendChild(div);
                });
            } catch (err) {
                console.error(err);
                roomGrid.innerHTML = '<p>호실 정보를 불러오는데 실패했습니다.</p>';
            }
        }

        let selectedRoomId = null; // 모달에서 사용할 호실 ID

        function openStatusModal(roomId, roomNumber, currentStatus) {
            selectedRoomId = roomId;

            // 모달에 호실 정보 표시
            document.getElementById('modalRoomNumber').textContent = `호실: ${roomNumber}`;
            document.getElementById('modalRoomStatus').value = currentStatus;

            // 모달 띄우기
            const modal = new bootstrap.Modal(document.getElementById('statusModal'));
            modal.show();
        }

        // 저장 버튼 클릭 이벤트
        document.getElementById('saveStatusBtn').addEventListener('click', () => {
            const newStatus = document.getElementById('modalRoomStatus').value;
            if (!selectedRoomId) return;

            fetch(`/api/rooms/${selectedRoomId}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            })
            .then(res => {
                if (res.ok) {
                    const modalEl = document.getElementById('statusModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                    loadRooms(); // 갱신
                } else {
                    alert('상태 변경 실패');
                }
            })
            .catch(err => {
                console.error(err);
                alert('오류 발생');
            });
        });
    </script>
</main>

<footer th:replace="~{fragments/footer :: footerFragment}"></footer>
</body>
</html>
