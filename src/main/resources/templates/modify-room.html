<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: headFragment}"> </head>

<body>
<header th:replace="~{fragments/header :: headerFragment}"></header>

<main class="container-fluid px-4 mt-4">
    <!-- 메인 컨텐츠 -->
    <div class="container">
        <div class="page-header">
            <h2>호실 관리</h2>
            <p>호실을 추가/삭제합니다.</p>
        </div>

        <!-- 생활관 선택 -->           
        <div class="filter-section d-flex gap-3 mb-4">
            <div class="filter-group flex-fill">
                <label for="dormSelect" class="form-label">생활관 선택</label>
                    <select class="form-select form-select-lg" id="dormSelect" required>
                    <option value="" selected disabled>생활관을 선택하세요</option>
                    <option th:each="dorm : ${dorms}" 
                            th:value="${dorm.dormCode}"
                            th:text="${dorm.dormCode} + '동{' + ${dorm.dormName} + '}'"></option>
                </select>
            </div>

            <div class="d-flex align-items-end">
                <button class="btn btn-primary" onclick="loadRooms()">조회</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-5">
                <div class="row g-4">
                    <div class="col-md-12">
                        <div class="card p-4 h-100" style="height: 400px !important;">
                            <h4 class="mb-3">호실 목록</h4>
                            <!-- 호실 그리드 -->
                            <div class="floor-div col" id="floorDiv" style="overflow-x: hidden; overflow-y: auto; height: 300px !important;">
                                <div class="empty-state" id="emptyState" style="margin-top: 70px;">
                                    <p>생활관을 선택하여 호실을 조회하세요.</p>
                                </div>
                            </div> 
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-7">
                <div class="row g-4">
                    <!-- 호실 추가 -->
                    <div class="col-md-6">
                        <div class="card p-4 h-100">
                            <h4 class="mb-3">호실 추가</h4>
                            <form id="createRoomForm">
                                <div class="mb-3">
                                    <label for="roomNumber" class="form-label">호실 번호</label>
                                    <input type="text" class="form-control" id="roomNumber" required>
                                </div>
                                <div class="form-bottom mt-auto">
                                    <button type="submit" class="btn btn-primary">호실 추가하기</button>
                                    <p id="roomStatus" class="status-msg text-muted">호실을 추가하려면 세부 정보를 입력하십시오.</p>
                                </div>    
                            </form>
                        </div>
                    </div>

                    <!-- 호실 삭제 -->
                    <div class="col-md-6">
                        <div class="card p-4 h-100">
                            <h4 class="mb-3">호실 삭제</h4>
                            <form id="deleteRoomForm">
                                <div class="mb-3">
                                    <label for="deleteRoomNumber" class="form-label">삭제할 호실 번호</label>
                                    <input type="text" class="form-control" id="deleteRoomNumber" required>
                                </div>
                                <div class="form-bottom mt-auto">
                                    <button type="submit" class="btn btn-primary">호실 삭제</button>
                                    <p id="deleteRoomStatus" class="status-msg text-muted">호실을 삭제하려면 세부 정보를 입력하십시오.</p>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        const dormSelect = document.getElementById('dormSelect');
        const emptyState = document.getElementById('emptyState');
        const floorDiv = document.getElementById('floorDiv');

        // 방 번호(숫자 + 알파벳) 파싱 함수
        function parseRoomNumber(roomNumber) {
            // 숫자 + 선택적 알파벳 1글자 (예: 805, 805A)
            const match = roomNumber.match(/^(\d+)([A-Za-z]?)$/);
            if (!match) return { num: Infinity, suffix: "" };

            return {
                num: Number(match[1]),     // 숫자
                suffix: match[2] || ""     // 알파벳 또는 빈 문자열
            };
        }

        // 정렬 함수
        function sortRooms(rooms) {
            return rooms.sort((a, b) => {
                const A = parseRoomNumber(a.roomNumber);
                const B = parseRoomNumber(b.roomNumber);

                // 1️⃣ 숫자 먼저 비교
                if (A.num !== B.num) return A.num - B.num;

                // 2️⃣ 알파벳 비교
                return A.suffix.localeCompare(B.suffix);
            });
        }


        // 조회 버튼 클릭 시 호실 정보 갱신
        async function loadRooms() {

            if (!emptyState) {
                console.warn('emptyState 요소가 없음');
                return;
            }

            floorDiv.innerHTML = '<p>로딩 중...</p>';
            emptyState.style.display = 'none';

            try {
                    const res = await fetch("/api/dorms");
                    const dorms = await res.json();

                    floorDiv.innerHTML = ``;
                    floorDiv.style.marginTop = "1rem";

                    for (const dorm of dorms) 
                    {
                        const roomRes = await fetch(`/api/rooms/info/byDorm?dormCode=${dorm.dormCode}`);
                        const rooms = await roomRes.json();

                        const table = document.createElement('table');
                        table.classList.add('room-table');

                        // rooms 배열을 층별로 그룹핑
                        const floors = {};

                        rooms.forEach(room => {
                            const floor = room.floor;    // 1, 2, 3 같은 층 정보
                            if (!floors[floor]) floors[floor] = [];
                            floors[floor].push(room);
                        });

                        Object.keys(floors).sort().forEach(floor => {
                            let row = document.createElement('tr');
                            
                            const sortedRooms = sortRooms(floors[floor]);
                            sortedRooms.forEach((room, index) => {

                                // td 생성
                                const td = document.createElement('td');
                                td.classList.add('room-cell');
                                td.innerHTML = `
                                    <div class="room-number fw-bold">${room.roomNumber}</div>
                                `;

                                row.appendChild(td);

                                // 10개마다 줄바꿈
                                if ((index + 1) % 5 === 0) {
                                    table.appendChild(row);
                                    row = document.createElement('tr');
                                }
                            });

                            // 남은 셀 추가
                            if (row.children.length > 0) {
                                table.appendChild(row);
                            }
                            
                            //구분선
                            const seperator = document.createElement('tr');
                            const sepCell = document.createElement('td');
                            sepCell.colSpan = 5;
                            sepCell.classList.add('floor-separator');
                            seperator.appendChild(sepCell);
                            table.appendChild(seperator);
                        });
                        floorDiv.appendChild(table);
                    }

            } catch (err) {
                console.error(err);
                emptyState.innerHTML = `<p>생활관을 선택하여 호실을 조회하세요.</p>`;
                emptyState.style.display = 'flex';
            }
        }


        // 호실 추가
        document.getElementById('createRoomForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dormCode = dormSelect.value;
            const roomNumber = document.getElementById('roomNumber').value;
            const statusEl = document.getElementById('roomStatus');
            

            if (!dormCode) {
                statusEl.textContent = '⚠️ 생활관을 먼저 선택하세요.';
                statusEl.style.color = 'red';
                return;
            }

            try {
                const res = await axios.post('/api/rooms/create', {
                    dormCode: dormCode,
                    roomNumber: roomNumber
                });
                statusEl.textContent = `✅ ${roomNumber}호가 추가되었습니다.`;
                statusEl.style.color = 'blue';
                e.target.reset();
                loadRooms(); // 갱신
            } catch (err) {
                const message = err.response.data.message;
                statusEl.textContent = `⚠️ ${roomNumber}호 추가 실패: ${message}`;
                statusEl.style.color = 'red';
            }
        });

        // 호실 삭제
        document.getElementById('deleteRoomForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dormCode = dormSelect.value;
            const roomNumber = document.getElementById('deleteRoomNumber').value;
            const statusEl = document.getElementById('deleteRoomStatus');

            if (!dormCode) {
                statusEl.textContent = '⚠️ 생활관을 먼저 선택하세요.';
                statusEl.style.color = 'red';
                return;
            }

            try {
                await axios.delete(`/api/rooms/delete`,{
                    params: {
                        dormCode: dormCode,
                        roomNumber: roomNumber
                    }
                });

                statusEl.textContent = `✅ ${roomNumber}호가 삭제되었습니다.`;
                statusEl.style.color = 'blue';
                e.target.reset();
                loadRooms(); // 갱신
            } catch (err) {
                statusEl.textContent = `⚠️ ${roomNumber}호 삭제에 실패하였습니다.`;
                statusEl.style.color = 'red';
            }
        });
    </script>
</main>

<footer th:replace="~{fragments/footer :: footerFragment}"></footer>
</body>
</html>
