<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: headFragment}"> </head>

<body>
<header th:replace="~{fragments/header :: headerFragment}"></header>

<main class="container-fluid px-4 mt-4">
<!-- ë©”ì¸ ì»¨í…ì¸  -->
<div class="container">
    <div class="page-header">
        <h2>í˜¸ì‹¤ ê´€ë¦¬</h2>
        <p>í˜¸ì‹¤ì„ ì¶”ê°€/ì‚­ì œí•©ë‹ˆë‹¤.</p>
    </div>

    <!-- ìƒí™œê´€ ì„ íƒ -->
    <div class="filter-section d-flex gap-3 mb-4">
        <div class="filter-group flex-fill">
            <label for="dormSelect" class="form-label">ìƒí™œê´€ ì„ íƒ</label>
                <select class="form-select form-select-lg" id="dormSelect" required>
                <option value="" selected disabled>ìƒí™œê´€ì„ ì„ íƒí•˜ì„¸ìš”</option>
                <option th:each="dorm : ${dorms}"
                        th:value="${dorm.dormCode}"
                        th:text="${dorm.dormCode} + 'ë™'"></option>
            </select>
        </div>

        <div class="d-flex align-items-end">
            <button class="btn btn-primary" onclick="loadRooms()">ì¡°íšŒ</button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-5">
            <div class="row g-4">
                <div class="col-md-12">
                    <div class="card p-4 h-100" style="height: 560px !important;">
                        <h4 class="mb-3">í˜¸ì‹¤ ëª©ë¡</h4>
                        <!-- í˜¸ì‹¤ ê·¸ë¦¬ë“œ -->
                        <div class="floor-div col" id="floorDiv" style="overflow-x: hidden; overflow-y: auto; height: 400px !important;">
                            <div class="empty-state" id="emptyState" style="margin-top: 120px;">
                                <p>ìƒí™œê´€ì„ ì„ íƒí•˜ì—¬ í˜¸ì‹¤ì„ ì¡°íšŒí•˜ì„¸ìš”.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-7">
            <div class="row g-4">
                <!-- í˜¸ì‹¤ ì¶”ê°€ -->
                <div class="col-md-6">
                    <div class="card p-4 h-100">
                        <h4 class="mb-3">í˜¸ì‹¤ ì¶”ê°€</h4>
                        <form id="createRoomForm">
                            <div class="mb-3">
                                <label for="roomNumber" class="form-label">í˜¸ì‹¤ ë²ˆí˜¸</label>
                                <input type="text" class="form-control" id="roomNumber" required>
                            </div>
                            <div class="form-bottom mt-auto">
                                <button type="submit" class="btn btn-primary">í˜¸ì‹¤ ì¶”ê°€</button>
                                <p id="roomStatus" class="status-msg text-muted">í˜¸ì‹¤ì„ ì¶”ê°€í•˜ë ¤ë©´ ì„¸ë¶€ ì •ë³´ë¥¼ ì…ë ¥í•˜ì‹­ì‹œì˜¤.</p>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- í˜¸ì‹¤ ì‚­ì œ -->
                <div class="col-md-6">
                    <div class="card p-4 h-100">
                        <h4 class="mb-3">í˜¸ì‹¤ ì‚­ì œ</h4>
                        <form id="deleteRoomForm">
                            <div class="mb-3">
                                <label for="deleteRoomNumber" class="form-label">ì‚­ì œí•  í˜¸ì‹¤ ë²ˆí˜¸</label>
                                <input type="text" class="form-control" id="deleteRoomNumber" required>
                            </div>
                            <div class="form-bottom mt-auto">
                                <button type="submit" class="btn btn-primary">í˜¸ì‹¤ ì‚­ì œ</button>
                                <p id="deleteRoomStatus" class="status-msg text-muted">í˜¸ì‹¤ì„ ì‚­ì œí•˜ë ¤ë©´ ì„¸ë¶€ ì •ë³´ë¥¼ ì…ë ¥í•˜ì‹­ì‹œì˜¤.</p>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="row g-4 mt-1">
                <!-- í˜¸ì‹¤ ì¼ê´„ ì¶”ê°€ -->
                <div class="col-md-6">
                    <div class="card p-4 h-100">
                        <h4 class="mb-3">í˜¸ì‹¤ ì¼ê´„ ì¶”ê°€</h4>
                        <div class="form-bottom mt-1">
                            <!-- íŒŒì¼ ì—…ë¡œë“œ -->
                            <input type="file" id="roomExcelFile" accept=".xlsx, .xls" class="form-control mb-3">

                            <!-- ì–‘ì‹ ë‹¤ìš´ë¡œë“œ -->
                            <button class="btn btn-secondary" onclick="downloadExcelTemplate()">
                                ì–‘ì‹ ë°›ê¸°
                            </button>

                            <!-- ë“±ë¡ ë²„íŠ¼ -->
                            <button class="btn btn-primary" onclick="uploadExcelRooms()">
                                ì¼ê´„ ë“±ë¡
                            </button>

                            <p id="allRoomStatus" class="status-msg text-muted mt-2">
                                ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ í˜¸ì‹¤ì„ ë“±ë¡í•˜ì‹­ì‹œì˜¤.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- í˜¸ì‹¤ ì¼ê´„ ì‚­ì œ -->
                <div class="col-md-6">
                    <div class="card p-4 h-100">
                        <h4 class="mb-3">í˜¸ì‹¤ ì¼ê´„ ì‚­ì œ</h4>
                        <p class="mt-2 mb-2" style="font-size: 14px;">ìƒí™œê´€ì„ ì„ íƒí•˜ê³  í˜¸ì‹¤ì„ ì¼ê´„ ì‚­ì œí•˜ì‹­ì‹œì˜¤.</p>
                        <form id="deleteAllRoomForm">
                            <div class="form-bottom mt-3 mb-3">
                                <button type="submit" class="btn btn-primary">ì¼ê´„ ì‚­ì œ</button>
                                <p id="deleteAllRoomStatus" class="status-msg text-muted mt-2">í˜¸ì‹¤ì„ ì¼ê´„ ì‚­ì œí•©ë‹ˆë‹¤.</p>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ì¼ê´„ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
    <div class="modal fade" id="confirmDeleteAllModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">í˜¸ì‹¤ ì¼ê´„ ì‚­ì œ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                ì •ë§ í•´ë‹¹ ìƒí™œê´€ì˜ ëª¨ë“  í˜¸ì‹¤ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
                ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" id="confirmDeleteAllBtn" class="btn btn-danger">ì˜ˆ, ì‚­ì œí•©ë‹ˆë‹¤</button>
            </div>

            </div>
        </div>
    </div>
</div>

<div class="progress-overlay" id="progressOverlay" style="display:none;">
    <div class="progress-modal">
        <p id="progressTitle" class="mb-2 fw-bold">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</p>

        <div class="progress mb-2 position-relative" style="height: 20px;">
            <div id="overlayProgressBar"
                class="progress-bar progress-bar-striped progress-bar-animated"
                role="progressbar"
                style="width: 0%;"></div>
            <span id="overlayProgressText"
                class="btn-progress-text position-absolute top-50 start-50 translate-middle fw-bold">
                0%
            </span>
        </div>

        <p id="progressSubText" style="font-size:13px;color:#666;">
            ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
        </p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const dormSelect = document.getElementById('dormSelect');
    const emptyState = document.getElementById('emptyState');
    const floorDiv = document.getElementById('floorDiv');

    // ë°© ë²ˆí˜¸(ìˆ«ì + ì•ŒíŒŒë²³) íŒŒì‹± í•¨ìˆ˜
    function parseRoomNumber(roomNumber) {
        // ìˆ«ì + ì„ íƒì  ì•ŒíŒŒë²³ 1ê¸€ì (ì˜ˆ: 805, 805A)
        const match = roomNumber.match(/^(\d+)([A-Za-z]?)$/);
        if (!match) return { num: Infinity, suffix: "" };

        return {
            num: Number(match[1]),     // ìˆ«ì
            suffix: match[2] || ""     // ì•ŒíŒŒë²³ ë˜ëŠ” ë¹ˆ ë¬¸ìì—´
        };
    }

    // ì •ë ¬ í•¨ìˆ˜
    function sortRooms(rooms) {
        return rooms.sort((a, b) => {
            const A = parseRoomNumber(a.roomNumber);
            const B = parseRoomNumber(b.roomNumber);

            // 1ï¸âƒ£ ìˆ«ì ë¨¼ì € ë¹„êµ
            if (A.num !== B.num) return A.num - B.num;

            // 2ï¸âƒ£ ì•ŒíŒŒë²³ ë¹„êµ
            return A.suffix.localeCompare(B.suffix);
        });
    }


    // ì¡°íšŒ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì‹¤ ì •ë³´ ê°±ì‹ 
    async function loadRooms() {

        if (!emptyState) {
            console.warn('emptyState ìš”ì†Œê°€ ì—†ìŒ');
            return;
        }

        floorDiv.innerHTML = '<p>ë¡œë”© ì¤‘...</p>';
        emptyState.style.display = 'none';

        try {
            floorDiv.innerHTML = ``;
            floorDiv.style.marginTop = "1rem";

            const dormCode = dormSelect.value;

            const roomRes = await fetch(`/admin/api/rooms/info/byDorm?dormCode=${dormCode}`);
            const rooms = await roomRes.json();

            const table = document.createElement('table');
            table.classList.add('room-table');

            // rooms ë°°ì—´ì„ ì¸µë³„ë¡œ ê·¸ë£¹í•‘
            const floors = {};

            rooms.forEach(room => {
                const floor = room.floor;    // 1, 2, 3 ê°™ì€ ì¸µ ì •ë³´
                if (!floors[floor]) floors[floor] = [];
                floors[floor].push(room);
            });

            Object.keys(floors).sort().forEach(floor => {
                let row = document.createElement('tr');

                const sortedRooms = sortRooms(floors[floor]);
                sortedRooms.forEach((room, index) => {

                    // td ìƒì„±
                    const td = document.createElement('td');
                    td.classList.add('room-cell');
                    td.innerHTML = `
                        <div class="room-number fw-bold">${room.roomNumber}</div>
                    `;

                    row.appendChild(td);

                    // 10ê°œë§ˆë‹¤ ì¤„ë°”ê¿ˆ
                    if ((index + 1) % 5 === 0) {
                        table.appendChild(row);
                        row = document.createElement('tr');
                    }
                });

                // ë‚¨ì€ ì…€ ì¶”ê°€
                if (row.children.length > 0) {
                    table.appendChild(row);
                }

                //êµ¬ë¶„ì„ 
                const seperator = document.createElement('tr');
                const sepCell = document.createElement('td');
                sepCell.colSpan = 5;
                sepCell.classList.add('floor-separator');
                seperator.appendChild(sepCell);
                table.appendChild(seperator);
            });
            floorDiv.appendChild(table);
        } catch (error) {
            const msg = error?.response?.data?.message;
            emptyState.innerHTML = `<p>${msg}</p>`;
            emptyState.style.display = 'flex';
        }
    }


    // í˜¸ì‹¤ ì¶”ê°€
    document.getElementById('createRoomForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const dormCode = dormSelect.value;
        const roomNumber = document.getElementById('roomNumber').value;
        const statusEl = document.getElementById('roomStatus');


        if (!dormCode) {
            statusEl.textContent = 'âš ï¸ ìƒí™œê´€ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.';
            statusEl.style.color = 'red';
            return;
        }

            try {
                const res = await axios.post('/admin/api/rooms/create', {
                    dormCode: dormCode,
                    roomNumber: roomNumber
                });
                statusEl.textContent = `âœ… ${roomNumber}í˜¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                statusEl.style.color = 'blue';
                e.target.reset();
                loadRooms(); // ê°±ì‹ 
            } catch (error) {
                const msg = error?.response?.data?.message;
                statusEl.textContent = `âš ï¸ ${msg}`;
                statusEl.style.color = 'red';
            }
        });

    // í˜¸ì‹¤ ì‚­ì œ
    document.getElementById('confirmDeleteAllBtn')
        .addEventListener('click', async () => {

        const dormCode = dormSelect.value;
        const statusEl = document.getElementById('deleteAllRoomStatus');

        if (!dormCode) {
            statusEl.textContent = 'âš ï¸ ìƒí™œê´€ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.';
            statusEl.style.color = 'red';
            return;
        }

        showProgressOverlay(
            'í˜¸ì‹¤ ì¼ê´„ ì‚­ì œ ì¤‘',
            `${dormCode}ë™ í˜¸ì‹¤ì„ ì‚­ì œí•˜ê³  ìˆìŠµë‹ˆë‹¤.`
        );

        try {
            const res = await fetch(`/admin/api/rooms/info/byDorm?dormCode=${dormCode}`);
            const rooms = await res.json();

            const total = rooms.length;
            let done = 0;

            if (total === 0) {
                updateProgress(100);
                hideProgressOverlay();
                return;
            }

            for (const room of rooms) {
                await axios.delete(`/admin/api/rooms/delete`, {
                    params: {
                        dormCode: dormCode,
                        roomNumber: room.roomNumber
                    }
                });

                done++;
                updateProgress(Math.round((done / total) * 100));
            }

            statusEl.textContent = 'âœ… ì„ íƒí•œ ìƒí™œê´€ì˜ í˜¸ì‹¤ì´ ì¼ê´„ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
            statusEl.style.color = 'blue';

            loadRooms();

            // ëª¨ë‹¬ ë‹«ê¸°
            bootstrap.Modal.getInstance(
                document.getElementById('confirmDeleteAllModal')
            ).hide();

        } catch (error) {
            const msg = error?.response?.data?.message || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ';
            statusEl.textContent = `âš ï¸ ${msg}`;
            statusEl.style.color = 'red';
        } finally {
            setTimeout(hideProgressOverlay, 400);
        }
    });

    // í˜¸ì‹¤ ë“±ë¡ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
    async function downloadExcelTemplate() {
        showProgressOverlay(
            'ì–‘ì‹ ë‹¤ìš´ë¡œë“œ ì¤‘',
            'ì—‘ì…€ ì–‘ì‹ì„ ë‹¤ìš´ë¡œë“œí•˜ê³  ìˆìŠµë‹ˆë‹¤.'
        );

        let p = 0;
        while (p < 90) {
            p += 5;
            updateProgress(p);
            await new Promise(resolve => setTimeout(resolve, p));
        }

        window.location.href = '/admin/api/Excel/download';

        updateProgress(100);

        setTimeout(hideProgressOverlay, 400);
    }

    // í˜¸ì‹¤ ì¼ê´„ ë“±ë¡
    async function uploadExcelRooms() {
        const dormCode = dormSelect.value;
        const statusEl = document.getElementById('allRoomStatus');
        const fileInput = document.getElementById('roomExcelFile');

        if (!fileInput.files.length) {
            statusEl.textContent = "âš ï¸ Excel íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.";
            statusEl.style.color = "red";
            return;
        }

        showProgressOverlay(
            'í˜¸ì‹¤ ì¼ê´„ ë“±ë¡ ì¤‘',
            'ì—‘ì…€ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.'
        );

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        try {
            await axios.post('/admin/api/Excel/register', formData, {
                headers: { "Content-Type": "multipart/form-data" },

                onUploadProgress: (progressEvent) => {
                    if (!progressEvent.total) return;
                    const percent = Math.round(
                        (progressEvent.loaded * 100) / progressEvent.total
                    );
                    updateProgress(percent);
                }
            });

            updateProgress(100);
            statusEl.textContent = "âœ… í˜¸ì‹¤ì„ ì¼ê´„ ë“±ë¡í•˜ì˜€ìŠµë‹ˆë‹¤.";
            statusEl.style.color = "blue";

            floorDiv.innerHTML = `<div class="empty-state" id="emptyState" style="margin-top: 120px;">
                                    <p>ìƒí™œê´€ì„ ì„ íƒí•˜ì—¬ í˜¸ì‹¤ì„ ì¡°íšŒí•˜ì„¸ìš”.</p>
                                </div>`;
        } catch (error) {
            const msg = error?.response?.data?.message;
            statusEl.textContent = `âš ï¸ ${msg}`;
            statusEl.style.color = "red";
        } finally {
            setTimeout(hideProgressOverlay, 400);
        }
    }


    // í˜¸ì‹¤ ì¼ê´„ ì‚­ì œ
    document.getElementById('deleteAllRoomForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const dormCode = dormSelect.value;
        const statusEl = document.getElementById('deleteAllRoomStatus');

        if (!dormCode) {
            statusEl.textContent = 'âš ï¸ ìƒí™œê´€ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.';
            statusEl.style.color = 'red';
            return;
        }

        const modal = new bootstrap.Modal(document.getElementById('confirmDeleteAllModal'));
        modal.show();
    });

    document.getElementById('confirmDeleteAllBtn')
        .addEventListener('click', async () => {

        const dormCode = dormSelect.value;
        const statusEl = document.getElementById('deleteAllRoomStatus');

        showProgressOverlay(
            'í˜¸ì‹¤ ì¼ê´„ ì‚­ì œ ì¤‘',
            'ì„ íƒí•œ ìƒí™œê´€ì˜ ëª¨ë“  í˜¸ì‹¤ì„ ì‚­ì œí•˜ê³  ìˆìŠµë‹ˆë‹¤.'
        );

        try {
            const res = await fetch(`/admin/api/rooms/info/byDorm?dormCode=${dormCode}`);
            const rooms = await res.json();

            const total = rooms.length;
            let done = 0;

            if (total === 0) {
                updateProgress(100);
                hideProgressOverlay();
                return;
            }

            for (const room of rooms) {
                await axios.delete(`/admin/api/rooms/delete`, {
                    params: {
                        dormCode: dormCode,
                        roomNumber: room.roomNumber
                    }
                });

                done++;
                const percent = Math.round((done / total) * 100);
                updateProgress(percent);

                // ğŸ‘€ UX í™•ì¸ìš© ì§€ì—° (í…ŒìŠ¤íŠ¸ ëë‚˜ë©´ ì œê±° ê°€ëŠ¥)
                await new Promise(r => setTimeout(r, 120));
            }

            updateProgress(100);
            statusEl.textContent = 'âœ… í˜¸ì‹¤ì´ ì¼ê´„ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
            statusEl.style.color = 'blue';

            loadRooms();

            // ëª¨ë‹¬ ë‹«ê¸°
            bootstrap.Modal.getInstance(
                document.getElementById('confirmDeleteAllModal')
            ).hide();

        } catch (error) {
            const msg = error?.response?.data?.message || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ';
            statusEl.textContent = `âš ï¸ ${msg}`;
            statusEl.style.color = 'red';
        } finally {
            setTimeout(hideProgressOverlay, 400);
        }
    });


    const overlay = document.getElementById('progressOverlay');
    const overlayBar = document.getElementById('overlayProgressBar');
    const overlayText = document.getElementById('overlayProgressText');
    const progressTitle = document.getElementById('progressTitle');
    const progressSubText = document.getElementById('progressSubText');

    function showProgressOverlay(title, subText) {
        progressTitle.textContent = title;
        progressSubText.textContent = subText;

        overlayBar.style.width = '0%';
        overlayText.textContent = '0%';

        overlay.style.display = 'flex';
        document.body.classList.add('blocked');
    }

    function updateProgress(percent) {
        overlayBar.style.width = `${percent}%`;
        overlayText.textContent = `${percent}%`;
    }

    function hideProgressOverlay() {
        overlay.style.display = 'none';
        document.body.classList.remove('blocked');
    }
</script>
</main>

<footer th:replace="~{fragments/footer :: footerFragment}"></footer>
</body>
</html>
