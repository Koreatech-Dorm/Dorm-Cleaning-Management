<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: headFragment}"></head>
<body>
<header th:replace="~{fragments/header :: headerFragment}"></header>

<main class="container-fluid px-4 mt-4">
    <div class="container">
        <div class="page-header mb-4">
            <h2>ìƒí™œê´€ ìƒíƒœ í™•ì¸</h2>
            <p>ìƒí™œê´€ê³¼ ì¸µì„ ì„ íƒí•˜ì—¬ í˜¸ì‹¤ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
        </div>

        <!-- í˜¸ì‹¤ ìƒíƒœ ì±…ê°ˆí”¼ -->
        <div class="status-tabs mb-0">
            <div class="tab-item active" data-status="">ì „ì²´</div>
            <div class="tab-item" data-status="OCCUPIED">ì¬ì‹¤</div>
            <div class="tab-item" data-status="VACANT">ê³µì‹¤ (ì²­ì†Œ í•„ìš”)</div>
            <div class="tab-item" data-status="READY">ê³µì‹¤ (ì²­ì†Œ ì™„ë£Œ)</div>
        </div>

        <!-- í•„í„° ì„¹ì…˜ -->
        <div class="filter-section d-flex gap-3 mt-0 mb-4">
            <div class="filter-group flex-fill">
                <label for="dormSelect" class="form-label">ìƒí™œê´€ ì„ íƒ</label>
                    <select class="form-select form-select-lg" id="dormSelect" required>
                    <option value="" selected disabled>ìƒí™œê´€ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="">ì „ì²´</option>
                    <option th:each="dorm : ${dorms}" 
                            th:value="${dorm.dormCode}"
                            th:text="${dorm.dormCode} + 'ë™'"></option>
                </select>
            </div>

            <div class="filter-group flex-fill">
                <label for="floorSelect" class="form-label">ì¸µ ì„ íƒ</label>
                <select class="form-select form-select-lg" id="floorSelect" required>
                    <option value="">ì¸µì„ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>

            <div class="d-flex align-items-end">
                <button class="btn btn-primary" onclick="loadRooms()">ì¡°íšŒ</button>
            </div>
        </div>

        <div class="position-relative mb-3">
            <!-- ìƒíƒœ ë²”ë¡€ -->
            <div class="legend d-flex gap-3 position-absolute start-50 translate-middle-x">
                <div class="legend-item d-flex align-items-center gap-1">
                    <span class="legend-color occupied"></span> ì¬ì‹¤
                </div>
                <div class="legend-item d-flex align-items-center gap-1">
                    <span class="legend-color vacant"></span> ê³µì‹¤ (ì²­ì†Œ í•„ìš”)
                </div>
                <div class="legend-item d-flex align-items-center gap-1">
                    <span class="legend-color ready"></span> ê³µì‹¤ (ì²­ì†Œ ì™„ë£Œ)
                </div>
            </div>

            <!-- ì¼ê´„ ìƒíƒœ ë³€ê²½ ì»¨íŠ¸ë¡¤ -->
            <div id="bulkSection" class="bulk-section d-flex align-items-center gap-3 position-absolute end-0" style="display: flex !important;">
                <div class="align-items-center gap-3 position-absolute end-0" style="margin-right: 0.3rem; width: 300px;">
                    <button id="bulkSelectBtn" class="btn btn-primary position-absolute end-0">í¸ì§‘</button>
                </div>
                <div class="align-items-center gap-3 position-absolute end-0" style="display: flex; flex-direction: row; margin-top: 10rem; margin-right: -1rem; width: 400px;">
                    <button id="selectAllBtn" class="btn btn-primary">ì „ì²´ì„ íƒ</button>
                    <div class="bulk-status-group align-items-center">
                        <select id="bulkStatusSelect" class="form-select form-select-sm" style="display: none;">
                            <option value="OCCUPIED">ì¬ì‹¤</option>
                            <option value="VACANT">ê³µì‹¤ (ì²­ì†Œ í•„ìš”)</option>
                            <option value="READY">ê³µì‹¤ (ì²­ì†Œ ì™„ë£Œ)</option>
                        </select>
                    </div>
                    <button id="applyBulkBtn" class="btn btn-primary" style="display: none;">ì ìš©</button>
                </div>
            </div>
        </div>

        <!-- í˜¸ì‹¤ ê·¸ë¦¬ë“œ -->
        <div class="dorm-div col" id="dormDiv" style="margin-top: 6rem;">
            <div class="empty-state" id="emptyState"> 
                <div class="loader"></div>
                <p>ë¡œë”©ì¤‘...</p> 
            </div>
        </div> 

        <!-- ìƒíƒœ ë³€ê²½ ëª¨ë‹¬ -->
        <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statusModalLabel">í˜¸ì‹¤ ìƒíƒœ ë³€ê²½</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                </div>
                <div class="modal-body">
                    <p id="modalRoomNumber"></p>
                    <p id="modalRoomTime"></p>
                    <select class="form-select" id="modalRoomStatus">
                    <option value="OCCUPIED">ì¬ì‹¤</option>
                    <option value="VACANT">ê³µì‹¤ (ì²­ì†Œ í•„ìš”)</option>
                    <option value="READY">ê³µì‹¤ (ì²­ì†Œ ì™„ë£Œ)</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-primary" id="saveStatusBtn">ì €ì¥</button>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ”’ ì§„í–‰ ì¤‘ ì˜¤ë²„ë ˆì´ -->
    <div id="progressOverlay" class="progress-overlay" style="display:none;">
        <div class="progress-modal shadow">
            <h5 class="mb-3">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤</h5>

            <div class="progress mb-2 position-relative" style="height: 20px;">
                <div id="overlayProgressBar"
                    class="progress-bar progress-bar-striped progress-bar-animated"
                    role="progressbar"
                    style="width: 0%;">
                </div>
                <span id="overlayProgressText"
                    class="btn-progress-text position-absolute top-50 start-50 translate-middle fw-bold" 
                    style="visibility: hidden;">
                    0%
                </span>
            </div>

            <small class="text-muted">
                ì„ íƒëœ í•­ëª©ì„ ì¼ê´„ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.<br>
                ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.
            </small>
        </div>
    </div>

    <script>
        const dormSelect = document.getElementById('dormSelect');
        const floorSelect = document.getElementById('floorSelect');
        const dormDiv = document.getElementById('dormDiv');
        const emptyState = document.getElementById('emptyState');
        const bulkSection = document.getElementById('bulkSection');
        const bulkSelectBtn   = document.getElementById('bulkSelectBtn');
        const selectAllBtn    = document.getElementById('selectAllBtn');
        const bulkStatusSelect = document.getElementById('bulkStatusSelect');
        const applyBulkBtn    = document.getElementById('applyBulkBtn');


        // ë°© ë²ˆí˜¸(ìˆ«ì + ì•ŒíŒŒë²³) íŒŒì‹± í•¨ìˆ˜
        function parseRoomNumber(roomNumber) {
            // ìˆ«ì + ì„ íƒì  ì•ŒíŒŒë²³ 1ê¸€ì (ì˜ˆ: 805, 805A)
            const match = roomNumber.match(/^(\d+)([A-Za-z]?)$/);
            if (!match) return { num: Infinity, suffix: "" };

            return {
                num: Number(match[1]),     // ìˆ«ì
                suffix: match[2] || ""     // ì•ŒíŒŒë²³ ë˜ëŠ” ë¹ˆ ë¬¸ìì—´
            };
        }

        // ì •ë ¬ í•¨ìˆ˜
        function sortRooms(rooms) {
            return rooms.sort((a, b) => {
                const A = parseRoomNumber(a.roomNumber);
                const B = parseRoomNumber(b.roomNumber);

                // 1ï¸âƒ£ ìˆ«ì ë¨¼ì € ë¹„êµ
                if (A.num !== B.num) return A.num - B.num;

                // 2ï¸âƒ£ ì•ŒíŒŒë²³ ë¹„êµ
                return A.suffix.localeCompare(B.suffix);
            });
        }

        // ì‹œê°„ í¬ë©§ í•¨ìˆ˜
        function formatTime(raw) {
            if (!raw) return "";  // null ëŒ€ì‘
            
            // "2025-12-09 06:46:55.089332" â†’ "2025-12-09T06:46:55.089332"
            const iso = raw.replace(" ", "T");

            const date = new Date(iso);
            if (isNaN(date)) return raw; // íŒŒì‹± ì‹¤íŒ¨í•˜ë©´ ì›ë³¸ ì¶œë ¥

            const MM = String(date.getMonth()).padStart(2, "0");
            const dd = String(date.getDate()).padStart(2, "0");
            const hh = String(date.getHours()).padStart(2, "0");
            const mm = String(date.getMinutes()).padStart(2, "0");

            return `${MM}/${dd} ${hh}:${mm}`;
        }

        let allRooms = []; // ì „ì²´ ë°© ë°ì´í„°ë¥¼ ì €ì¥
        async function initRooms() {
            try {
                const res = await fetch("/admin/api/rooms/all");
                allRooms = await res.json();
                renderAllGrids(allRooms);
                applyDormFloorFilter("", "");
                emptyState.style.display = "none";
            } catch (error) {
                const msg = error?.response?.data?.message;
                alert(msg);
            }
        }

        initRooms();

        const floorInfo = {};
        function renderAllGrids(rooms) {
            // ë°©ì„ ìƒí™œê´€ â†’ ì¸µ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í™”
            const grouped = {};

            const sortedRooms = sortRooms(rooms);
            sortedRooms.forEach(room => {
                if (!grouped[room.dormCode]) {
                    grouped[room.dormCode] = {};
                    floorInfo[room.dormCode] = [];
                }
                if (!grouped[room.dormCode][room.floor]) {
                    grouped[room.dormCode][room.floor] = [];
                    floorInfo[room.dormCode].push(room.floor);
                }
                grouped[room.dormCode][room.floor].push(room);
            });

            dormDiv.innerHTML = ""; // ì „ì²´ ì´ˆê¸°í™”

            for (const dorm in grouped) {
                const dormTitle = document.createElement('h3');
                dormTitle.classList.add('dorm-title', 'section-title');
                dormTitle.textContent = `${dorm}ë™`;
                dormTitle.dataset.dormCode = dorm;
                dormDiv.appendChild(dormTitle);

                const floorDiv = document.createElement('div');
                floorDiv.classList.add('floor-div', 'scroll-bar');
                floorDiv.dataset.dormCode = dorm;
                for (const floor in grouped[dorm]) {
                    const floorTitle = document.createElement('h4');
                    floorTitle.classList.add('floor-title', 'section-title');
                    floorTitle.style.display = 'none';
                    floorTitle.textContent = `${floor}ì¸µ`;
                    floorTitle.dataset.dormCode = dorm;
                    floorTitle.dataset.floor = floor;
                    floorDiv.appendChild(floorTitle);

                    const container = document.createElement("div");
                    container.classList.add('room-grid', 'initial','row');
                    container.dataset.dormCode = dorm;
                    container.dataset.floor = floor;

                    grouped[dorm][floor].forEach(room => {
                        const div = makeRoomCard(room);
                        container.appendChild(div);
                    });

                    floorDiv.appendChild(container);
                }
                dormDiv.appendChild(floorDiv);
            }
        }

        function makeRoomCard(room) {
            const div = document.createElement('div');
            div.classList.add('room-card', 'col-2', 'mb-3', 'p-2');

            let time = null;
            if (room.roomStatus === 'OCCUPIED') {
                div.classList.add('occupied');
                time = formatTime(room.checkInAt);
            }
            else if (room.roomStatus === 'VACANT') {
                div.classList.add('vacant');
                time = formatTime(room.checkOutAt);
            }
            else {
                div.classList.add('ready');
                time = formatTime(room.cleanedAt);
            }

            div.dataset.dormCode = room.dormCode;
            div.dataset.roomNumber = room.roomNumber;
            div.dataset.roomStatus = room.roomStatus;
            div.dataset.time = time;

            div.innerHTML = `
                <div class="room-number fw-bold">${div.dataset.roomNumber}</div>
                <div class="room-time fw-bold" style="display: none;">${div.dataset.time}</div>
            `;

            div.onclick = () => {
                bulkMode
                    ? selectRoom(div.dataset.dormCode, div.dataset.roomNumber)
                    : openStatusModal(div.dataset.dormCode, div.dataset.roomNumber, div.dataset.roomStatus, div.dataset.time);
            };

            return div;
        }

        function applyDormFloorFilter(dormCode, floor) {
            const dormTitles  = document.querySelectorAll(".dorm-title");
            const floorTitles = document.querySelectorAll(".floor-title");
            const floorDivs   = document.querySelectorAll(".floor-div");
            const grids       = document.querySelectorAll(".room-grid");

            const isDormAll  = dormCode === "";
            const isFloorAll = floor === "";

            // 1. ê¸°ìˆ™ì‚¬ íƒ€ì´í‹€
            dormTitles.forEach(dt => {
                dt.style.display = isDormAll ? "flex" : "none";
            });

            // 2. floor-div ìŠ¤í¬ë¡¤ ì²˜ë¦¬
            floorDivs.forEach(fd => {
                if (isDormAll) {
                    fd.classList.add("scroll-bar");
                } else {
                    fd.classList.remove("scroll-bar");
                }
            });

            // 3. ì¸µ íƒ€ì´í‹€
            floorTitles.forEach(ft => {
                const d = ft.dataset.dormCode;
                const f = ft.dataset.floor;

                const visible =
                    dormCode === d &&
                    (isFloorAll || floor === f);

                ft.style.display = visible ? "flex" : "none";
            });

            // 4. ë°© ì¹´ë“œ(grid)
            grids.forEach(grid => {
                const d = grid.dataset.dormCode;
                const f = grid.dataset.floor;

                const visible =
                    (isDormAll || dormCode === d) &&
                    (isFloorAll || floor === f);

                grid.style.display = visible ? "flex" : "none";

                if (!visible) return;

                // ì´ˆê¸° ìƒíƒœ í´ë˜ìŠ¤ ì²˜ë¦¬
                if (isDormAll) {
                    grid.classList.add("initial");
                } else {
                    grid.classList.remove("initial");
                }

                const cards = grid.querySelectorAll(".room-card");
                cards.forEach(card => {
                    const timeEl = card.querySelector(".room-time");

                    if (isDormAll) {
                        timeEl.style.display = "none";
                    } else {
                        timeEl.style.display = "flex";
                    }
                });
            });

            syncSelectAllButton();
        }

        function updateRoomCardUI(card, newStatus, newTime = "") {
            // ìƒíƒœ ê°±ì‹ 
            card.dataset.status = newStatus;

            // ìƒ‰ìƒ class ê°±ì‹ 
            card.classList.remove("occupied", "vacant", "ready");
            if (newStatus === "OCCUPIED") card.classList.add("occupied");
            else if (newStatus === "VACANT") card.classList.add("vacant");
            else card.classList.add("ready");

            // ì‹œê°„ ê°±ì‹ 
            const isDormAll = dormSelect.value === "";
            const timeEl = card.querySelector(".room-time");
            if (timeEl) {
                card.dataset.time = newTime;
                timeEl.textContent = newTime;
                if (isDormAll) {
                    timeEl.style.display = "none";
                } else {
                    timeEl.style.display = "flex";
                }
            }
        }

        async function loadRooms() {
            const dormCode = dormSelect.value;
            const floor = floorSelect.value;
            
            bulkMode = true;
            document.getElementById('bulkSelectBtn').click();
            applyDormFloorFilter(dormCode, floor);
        }


        // ìƒí™œê´€ ì„ íƒ ì‹œ ì¸µ ë“œë¡­ë‹¤ìš´ë§Œ ê°±ì‹ 
        dormSelect.addEventListener('change', async () => {
            const dormCode = dormSelect.value;

            // ì¸µ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
            floorSelect.innerHTML = '<option value="" selected disabled>ì¸µì„ ì„ íƒí•˜ì„¸ìš”</option>';
            
            if (!dormCode) return;

            const floors = floorInfo[dormCode];

            if (!floors || floors.length === 0) return;

            floors.forEach(floor => {
                const opt = document.createElement('option');
                opt.value = floor;
                opt.textContent = `${floor}ì¸µ`;
                floorSelect.appendChild(opt);
            });

            // ê°±ì‹ 
            loadRooms(); 
            resetStatusTabs();

            bulkMode = true;
            document.getElementById('bulkSelectBtn').click();
        });

        // ëª¨ë‹¬ì—ì„œ ì‚¬ìš©í•  ì •ë³´
        let selectedDormCode = null; 
        let selectedRoomNumber = null; 

        function openStatusModal(dormCode, roomNumber, currentStatus, time) {
            selectedDormCode = dormCode;
            selectedRoomNumber = roomNumber;

            // ëª¨ë‹¬ì— í˜¸ì‹¤ ì •ë³´ í‘œì‹œ
            document.getElementById('modalRoomNumber').textContent = `í˜¸ì‹¤: ${roomNumber}`;
            let comment = "";
            if (currentStatus === "OCCUPIED") {
                comment += "ì…ì‹¤";
            } else if (currentStatus === "VACANT") {
                comment += "í‡´ì‹¤";
            } else {
                comment += "ì²­ì†Œ ì™„ë£Œ";
            }
            document.getElementById('modalRoomTime').textContent = `${comment} ì‹œê°„: ${time}`;
            document.getElementById('modalRoomStatus').value = currentStatus;

            // ëª¨ë‹¬ ë„ìš°ê¸°
            const modal = new bootstrap.Modal(document.getElementById('statusModal'));
            modal.show();
        }

        // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('saveStatusBtn').addEventListener('click', async () => {
            const newStatus = document.getElementById('modalRoomStatus').value;

            if (!selectedDormCode || !selectedRoomNumber) return;

            try {
                const res = await fetch(`/admin/api/rooms/${selectedRoomNumber}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dormCode: selectedDormCode,
                        newRoomStatus: newStatus
                    })
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw errorData;
                }

                const updatedRoom = await res.json();

                const card = document.querySelector(
                    `.room-card[data-dorm-code="${selectedDormCode}"][data-room-number="${selectedRoomNumber}"]`
                );

                if (card) {
                    // ìƒíƒœ
                    card.dataset.roomStatus = updatedRoom.roomStatus;

                    // ì‹œê°„ ì„ íƒ
                    let time = "";
                    if (updatedRoom.roomStatus === "OCCUPIED")
                        time = formatTime(updatedRoom.checkInAt);
                    else if (updatedRoom.roomStatus === "VACANT")
                        time = formatTime(updatedRoom.checkOutAt);
                    else
                        time = formatTime(updatedRoom.cleanedAt);

                    // UI ë°˜ì˜
                    updateRoomCardUI(card, updatedRoom.roomStatus, time);
                    applyStatusFilter(selectedStatus);
                }

                bootstrap.Modal.getInstance(
                    document.getElementById('statusModal')
                ).hide();

            } catch (error) {
                const msg = error?.response?.data?.message;
                alert(msg);
            }
        });

        // ë³´ì´ëŠ” ì¹´ë“œë§Œ ê°€ì ¸ì˜¤ê¸°
        function getVisibleRoomCards() {
            return Array.from(document.querySelectorAll('.room-card'))
                .filter(card => card.offsetParent !== null);
        }

        // ì „ì²´ ì„ íƒ íŒë³„
        function isAllSelected(cards) {
            return cards.length > 0 && cards.every(card =>
                selectedRooms.has(roomKey(card.dataset.dormCode, card.dataset.roomNumber))
            );
        }

        function syncSelectAllButton() {
            const cards = getVisibleRoomCards();
            updateSelectAllButton(isAllSelected(cards));
        }

        // ì „ì²´ ì„ íƒ/í•´ì œ 
        function toggleSelectAll() {
            const cards = getVisibleRoomCards();
            if (cards.length === 0) return;

            const shouldSelectAll = !isAllSelected(cards);

            cards.forEach(card => {
                const key = roomKey(card.dataset.dormCode, card.dataset.roomNumber);

                if (shouldSelectAll) {
                    selectedRooms.add(key);
                    card.classList.remove('select-mode');
                    card.classList.add('selected');
                } else {
                    selectedRooms.delete(key);
                    card.classList.remove('selected');
                    card.classList.add('select-mode');
                }
            });

            updateSelectAllButton(shouldSelectAll);
        }

        // UI ê°±ì‹ 
        function updateSelectAllButton(isSelected) {
            selectAll = isSelected;

            if (isSelected) {
                selectAllBtn.classList.replace("btn-primary", "btn-secondary");
                selectAllBtn.textContent = "ì„ íƒí•´ì œ";
            } else {
                selectAllBtn.classList.replace("btn-secondary", "btn-primary");
                selectAllBtn.textContent = "ì „ì²´ì„ íƒ";
            }
        }
        selectAllBtn.addEventListener('click', toggleSelectAll);

        let bulkMode = false;
        function enableBulkMode() {
            bulkMode = true;

            document.querySelectorAll('.room-card').forEach(card => {
                card.classList.add('select-mode');
            });

            bulkSelectBtn.classList.replace('btn-primary', 'btn-secondary');
            bulkSelectBtn.textContent = 'ì·¨ì†Œ';

            selectAllBtn.style.display = 'flex';
            bulkStatusSelect.style.display = 'flex';
            applyBulkBtn.style.display = 'flex';

            syncSelectAllButton(); // ì „ì²´ì„ íƒ ìƒíƒœ ë°˜ì˜
        }

        function disableBulkMode() {
            bulkMode = false;

            document.querySelectorAll('.room-card').forEach(card => {
                card.classList.remove('select-mode', 'selected');
            });

            bulkSelectBtn.classList.replace('btn-secondary', 'btn-primary');
            bulkSelectBtn.textContent = 'í¸ì§‘';

            selectAllBtn.style.display = 'none';
            bulkStatusSelect.style.display = 'none';
            applyBulkBtn.style.display = 'none';

            selectedRooms.clear();
            syncSelectAllButton();
        }

        bulkSelectBtn.addEventListener('click', () => {
            bulkMode ? disableBulkMode() : enableBulkMode();
        });
        
        // ì„ íƒëª¨ë“œì—ì„œ í˜¸ì‹¤ ì„ íƒ
        function selectRoom(dormCode, roomNumber) {
            if (!bulkMode) return;

            const room = document.querySelector(
                `.room-card[data-dorm-code="${dormCode}"][data-room-number="${roomNumber}"]`
            );
            if (!room || room.offsetParent === null) return;

            const key = roomKey(dormCode, roomNumber);

            if (!selectedRooms.has(key)) {
                selectedRooms.add(key);
                room.classList.remove('select-mode');
                room.classList.add('selected');
            } else {
                selectedRooms.delete(key);
                room.classList.remove('selected');
                room.classList.add('select-mode');
            }

            syncSelectAllButton();
        }

        // ì„ íƒëœ ë°© ëª©ë¡
        let selectedRooms = new Set();
        function roomKey(dormCode, roomNumber) {
            return `${dormCode}|${roomNumber}`;
        }

        // í˜¸ì‹¤ ìƒíƒœ ì¼ê´„ ë³€ê²½
        async function updateAllSelectedRoom() {
            if (selectedRooms.size === 0) return;

            showProgressOverlay();

            try {
                const newStatus = bulkStatusSelect.value;

                const grouped = {};
                selectedRooms.forEach(key => {
                    const [dormCode, roomNumber] = key.split("|");
                    if (!grouped[dormCode]) grouped[dormCode] = [];
                    grouped[dormCode].push(roomNumber);
                });

                const tasks = Object.entries(grouped);
                const total = tasks.length;
                let done = 0;

                await Promise.all(
                    tasks.map(async ([dormCode, roomNumbers]) => {
                        try {
                            const res = await fetch(`/admin/api/rooms/bulk-status`, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    dormCode,
                                    roomNumbers,
                                    newRoomStatus: newStatus
                                })
                            });

                            if (!res.ok) throw await res.json();

                            const { updatedCount, time } = await res.json();
                            console.log(`${dormCode}: ${updatedCount}ê°œ ë°© ìƒíƒœ ë³€ê²½ë¨`);

                            roomNumbers.forEach(roomNumber => {
                                const card = document.querySelector(
                                    `.room-card[data-dorm-code="${dormCode}"][data-room-number="${roomNumber}"]`
                                );
                                if (card) {
                                    updateRoomCardUI(card, newStatus, formatTime(time));
                                }
                            });

                        } catch (error) {
                            console.error(`âŒ ${dormCode} ì‹¤íŒ¨`);
                        } finally {
                            done++;
                            updateOverlayProgress(done, total);
                        }
                    })
                );
                applyStatusFilter(selectedStatus);
            } finally {
                setTimeout(hideProgressOverlay, 400);
            }
        }


        // ì¼ê´„ ë³€ê²½ ì ìš© ë²„íŠ¼ 
        document.getElementById('applyBulkBtn').addEventListener('click', async () => {
            await updateAllSelectedRoom();
            document.getElementById('bulkSelectBtn').click();
            selectedRooms.clear();
            syncSelectAllButton();
        });

        // ì±…ê°ˆí”¼ ìƒíƒœ í•„í„°
        const statusTabs = document.querySelectorAll('.status-tabs .tab-item');

        statusTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                statusTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                selectedStatus = tab.dataset.status;

                applyStatusFilter(selectedStatus);
            });
        });

        // ìƒíƒœ í•„í„° ì ìš© í•¨ìˆ˜
        let selectedStatus = "";
        function applyStatusFilter(status) {
            const cards = Array.from(document.querySelectorAll('.room-card'));

            cards.forEach(card => {
                const cardStatus = 
                    card.classList.contains('occupied') ? "OCCUPIED" :
                    card.classList.contains('vacant') ? "VACANT" :
                    "READY";

                card.style.display =
                    (status === "" || status === cardStatus) ? "flex" : "none";
            });

            syncSelectAllButton();
        }

        // ìƒíƒœ ê¸°ì¤€ìœ¼ë¡œ ê²€ìƒ‰ íƒ­ ì´ˆê¸°í™”
        function resetStatusTabs() {
            const tabs = document.querySelectorAll('.status-tabs .tab-item');

            tabs.forEach(tab => tab.classList.remove('active'));

            const allTab = document.querySelector('.status-tabs .tab-item[data-status=""]');
            if (allTab) {
                allTab.classList.add('active');
            }
        }

        const overlay = document.getElementById('progressOverlay');
        const overlayBar = document.getElementById('overlayProgressBar');
        const overlayText = document.getElementById('overlayProgressText');

        function showProgressOverlay() {
            overlay.style.display = 'flex';
            overlayBar.style.width = '0%';
            overlayText.textContent = '0%';
            overlayText.style.visibility = "visible";
            document.body.classList.add('blocked');
        }

        function updateOverlayProgress(done, total) {
            const percent = Math.round((done / total) * 100);
            overlayBar.style.width = `${percent}%`;
            overlayText.textContent = `${percent}%`;
            overlayText.style.visibility = "visible";
        }

        function hideProgressOverlay() {
            overlay.style.display = 'none';
            overlayText.style.visibility = "hidden";
            document.body.classList.remove('blocked');
        }

    </script>
</main>

<footer th:replace="~{fragments/footer :: footerFragment}"></footer>
</body>
</html>
