<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: headFragment}"></head>
<body>
<header th:replace="~{fragments/header :: headerFragment}"></header>

<div class="container d-flex justify-content-center mb-5">
    <div class="card qr-card w-100">
        <div class="card-header">
            <h4 class="mb-0 fw-bold"><i class="bi bi-qr-code"></i> QR 코드 관리</h4>
            <p class="mb-0 small opacity-75">Dormitory QR Generator</p>
        </div>
        <div class="card-body p-4">

            <ul class="nav nav-tabs nav-fill mb-4" id="qrTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active fw-bold" id="single-tab" data-bs-toggle="tab" data-bs-target="#single" type="button" role="tab" aria-controls="single" aria-selected="true">
                        <i class="bi bi-file-earmark-image"></i> 개별 생성
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link fw-bold" id="bulk-tab" data-bs-toggle="tab" data-bs-target="#bulk" type="button" role="tab" aria-controls="bulk" aria-selected="false">
                        <i class="bi bi-file-zip"></i> 일괄 다운로드 (ZIP)
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="qrTabsContent">
                <div class="tab-pane fade show active" id="single" role="tabpanel" aria-labelledby="single-tab">
                    <form id="qrForm">
                        <div class="mb-3">
                            <label for="dormSelect" class="form-label">생활관 선택</label>
                            <select class="form-select form-select-lg" id="dormSelect" required>
                                <option value="" selected disabled>생활관을 선택하세요</option>
                                <option th:each="dorm : ${dorms}"
                                        th:value="${dorm.dormCode}"
                                        th:text="${dorm.dormCode} + '동'">
                                </option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="roomInput" class="form-label">호실 입력</label>
                            <input type="text" class="form-control form-control-lg" id="roomInput" placeholder="예: 101" required>
                        </div>

                        <button type="submit" class="btn orange-btn w-100 py-3 fw-bold rounded-pill">
                            QR 코드 생성하기
                        </button>
                    </form>

                    <div id="resultArea" class="mt-4" style="display: none;">
                        <hr class="my-4">
                        <h5 class="text-center mb-3 fw-bold text-dark">생성된 QR 코드</h5>
                        <div class="qr-display-area p-3">
                            <img id="qrImage" alt="QR Code" style="max-width: 100%; height: auto;">
                            <div id="loadingSpinner" class="spinner-border text-primary" role="status" style="display: none;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div class="mt-4 text-center">
                            <a id="downloadLink" href="#" class="btn btn-success w-100 py-2 fw-bold">
                                <i class="bi bi-download"></i> 이미지 다운로드
                            </a>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="bulk" role="tabpanel" aria-labelledby="bulk-tab">
                    <form id="bulkForm">
                        <div class="mb-3">
                            <label class="form-label d-block mb-3">다운로드할 생활관 선택</label>

                            <div class="form-check mb-2 p-3 border rounded bg-light">
                                <input class="form-check-input custom-check me-2" type="checkbox" id="checkAll">
                                <label class="form-check-label fw-bold" for="checkAll">
                                    전체 선택
                                </label>
                            </div>

                            <div class="dorm-list-container border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                <div class="form-check mb-2" th:each="dorm : ${dorms}">
                                    <input class="form-check-input dorm-checkbox" type="checkbox"
                                           name="dormCodes"
                                           th:value="${dorm.dormCode}"
                                           th:id="'dorm-' + ${dorm.dormCode}">
                                    <label class="form-check-label" th:for="'dorm-' + ${dorm.dormCode}"
                                           th:text="${dorm.dormCode} + '동'">
                                    </label>
                                </div>
                            </div>
                            <div class="form-text mt-2 text-muted">
                                <i class="bi bi-info-circle"></i> 선택한 생활관의 모든 호실 QR 코드가 압축파일로 다운로드됩니다.
                            </div>
                        </div>

                        <button
                            type="submit"
                            id="zipDownloadBtn"
                            class="btn orange-btn w-100 py-3 fw-bold rounded-pill position-relative overflow-hidden">

                            <span class="btn-label">
                                <i class="bi bi-file-earmark-zip"></i> ZIP 파일 다운로드
                            </span>

                            <div class="btn-progress position-absolute top-0 start-0 h-100"
                                style="width:0%"></div>

                            <span class="btn-progress-text position-absolute top-50 start-50 translate-middle fw-bold" style="visibility: hidden;">
                                0%
                            </span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 개별 생성 로직 ---
        document.getElementById('qrForm').addEventListener('submit', function(e) {
            e.preventDefault();
            generateQrCode();
        });

        // 일괄 다운로드 로직 ---

        // 전체 선택 기능
        const checkAll = document.getElementById('checkAll');
        const dormCheckboxes = document.querySelectorAll('.dorm-checkbox');

        checkAll.addEventListener('change', function() {
            dormCheckboxes.forEach(cb => cb.checked = checkAll.checked);
        });

        // 개별 체크박스 해제 시 전체 선택 해제
        dormCheckboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                if (!this.checked) {
                    checkAll.checked = false;
                } else {
                    const allChecked = Array.from(dormCheckboxes).every(cb => cb.checked);
                    checkAll.checked = allChecked;
                }
            });
        });

        // 다운로드 폼 제출
        document.getElementById('bulkForm').addEventListener('submit', function(e) {
            e.preventDefault();
            downloadZip();
        });
    });

    // 개별 QR 생성 함수
    function generateQrCode() {
        const dormCode = document.getElementById('dormSelect').value;
        const roomNumber = document.getElementById('roomInput').value;

        if (!dormCode || !roomNumber) {
            alert('생활관과 호실을 모두 입력해주세요.');
            return;
        }

        const resultArea = document.getElementById('resultArea');
        const qrImage = document.getElementById('qrImage');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const downloadLink = document.getElementById('downloadLink');

        resultArea.style.display = 'block';
        qrImage.style.display = 'none';
        loadingSpinner.style.display = 'block';

        const params = new URLSearchParams({ dormCode, roomNumber });
        const apiUrl = `/admin/api/qr/generate?${params.toString()}`;

        fetch(apiUrl)
            .then(async response => {
                if (!response.ok) {
                    // 서버에서 내려준 에러 메시지 파싱
                    const errorData = await response.json();
                    throw errorData;
                }
                return response.blob(); // PNG 이미지
            })
            .then(blob => {
                const imageUrl = URL.createObjectURL(blob);
                qrImage.src = imageUrl;
                qrImage.style.display = 'block';

                downloadLink.href = imageUrl;
                downloadLink.download = `QR_${dormCode}동_${roomNumber}호.png`;
            })
            .catch(error => {
                const msg = error?.response?.data?.message;
                alert(msg);
                resultArea.style.display = 'none';
            })
            .finally(() => {
                loadingSpinner.style.display = 'none';
            });
    }


    // 일괄 다운로드 함수
    async function downloadZip() {
        const checkedBoxes = document.querySelectorAll('.dorm-checkbox:checked');

        if (checkedBoxes.length === 0) {
            alert('최소 하나 이상의 생활관을 선택해주세요.');
            return;
        }

        const params = new URLSearchParams();
        checkedBoxes.forEach(cb => params.append('dormCodes', cb.value));

        const apiUrl = `/admin/api/qr/generate/zip?${params.toString()}`;

        updateProgress(0, '준비 중...');

        const response = await fetch(apiUrl);

        if (!response.ok) {
            alert('ZIP 다운로드 중 오류가 발생했습니다.');
            return;
        }

        const contentLength = response.headers.get('Content-Length');
        if (!contentLength) {
            updateProgress(0, '파일 크기 확인 중...');
            return;
        }

        const total = parseInt(contentLength, 10);
        let loaded = 0;

        const reader = response.body.getReader();
        const chunks = [];

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            chunks.push(value);
            loaded += value.length;

            const percent = Math.floor((loaded / total) * 100);
            updateProgress(percent);
        }

        const blob = new Blob(chunks, { type: 'application/zip' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'qr_codes.zip';
        document.body.appendChild(a);
        a.click();
        a.remove();

        URL.revokeObjectURL(url);

        updateProgress(100);
    }

    let visualPercent = 0;
    let targetPercent = 0;
    let animating = false;
    let isCompleted = false;
    function updateProgress(percent, text) {
        if (isCompleted) return;

        targetPercent = percent;

        const btn = document.getElementById('zipDownloadBtn');
        const label = btn.querySelector('.btn-progress-text');
        const defaultLabel = btn.querySelector('.btn-label');

        btn.classList.add('loading');

        defaultLabel.style.visibility = 'hidden';
        label.style.visibility = 'visible';
        label.textContent = text ?? percent + '%';

        if (!animating) {
            animating = true;
            requestAnimationFrame(animateProgress);
        }

        if (percent >= 100 && !isCompleted) {
            isCompleted = true;
            setTimeout(finishProgress, 300);
        }
    }

    function animateProgress() {
        const bar = document.querySelector('#zipDownloadBtn .btn-progress');

        if (visualPercent < targetPercent) {
            visualPercent += Math.max((targetPercent - visualPercent) * 0.08, 0.3);
            visualPercent = Math.min(visualPercent, targetPercent);
            bar.style.width = visualPercent + '%';
        }

        if (!isCompleted && visualPercent < targetPercent) {
            requestAnimationFrame(animateProgress);
        } else {
            animating = false;
        }
    }

    async function finishProgress() {
        const btn = document.getElementById('zipDownloadBtn');
        const bar = btn.querySelector('.btn-progress');
        const label = btn.querySelector('.btn-progress-text');
        const defaultLabel = btn.querySelector('.btn-label');

        bar.style.width = '100%';
        label.textContent = '✔ 완료';

        btn.classList.remove('loading');
        btn.classList.add('completed');

        setTimeout(() => {
            bar.style.width = '0%';
            visualPercent = 0;
            targetPercent = 0;
            isCompleted = false;

            label.textContent = '';
            defaultLabel.style.visibility = 'visible';
            btn.classList.remove('completed');
        }, 1500);
    }

</script>

<footer th:replace="~{fragments/footer :: footerFragment}"></footer>
</body>
</html>